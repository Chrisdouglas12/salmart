<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Email Verification - Salmart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: #212529;
    }

    .verification-container {
      background: #fff;
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 48px;
      max-width: 480px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.8);
      position: relative;
      overflow: hidden;
      transform: translateY(0);
      transition: all 0.3s ease;
    }

    .verification-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15), 0 10px 20px rgba(0, 0, 0, 0.08);
    }

    .verification-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #28a745, #20c997);
      border-radius: 24px 24px 0 0;
    }

    .brand-logo {
      font-size: 24px;
      font-weight: 800;
      color: #1a1a1a;
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      letter-spacing: -0.5px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, #28a745, #20c997);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
    }

    .status-icon {
      width: 88px;
      height: 88px;
      margin: 0 auto 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .status-icon::after {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      padding: 2px;
      background: linear-gradient(45deg, #28a745, #20c997, #28a745);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: exclude;
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .loading {
      background: linear-gradient(135deg, #28a745, #20c997);
      animation: pulse 2s infinite ease-in-out;
    }

    .loading::after {
      opacity: 1;
      animation: rotate 2s linear infinite;
    }

    .success {
      background: linear-gradient(135deg, #28a745, #20c997);
      animation: successPop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .error {
      background: linear-gradient(135deg, #dc3545, #c82333);
      animation: errorShake 0.6s ease-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.05); opacity: 1; }
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes successPop {
      0% { transform: scale(0) rotate(180deg); }
      60% { transform: scale(1.2) rotate(-10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    @keyframes errorShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
      20%, 40%, 60%, 80% { transform: translateX(8px); }
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .check-icon, .x-icon, .alert-icon {
      width: 36px;
      height: 36px;
      stroke-width: 3;
      color: #fff;
    }

    .message-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #1a1a1a;
      line-height: 1.2;
      letter-spacing: -0.5px;
    }

    .message-description {
      font-size: 17px;
      color: #6c757d;
      margin-bottom: 32px;
      line-height: 1.6;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .redirect-info {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 16px;
      padding: 24px;
      margin: 32px 0;
      border: 2px solid #28a745;
      position: relative;
      overflow: hidden;
    }

    .redirect-info::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(40, 167, 69, 0.1), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .redirect-text {
      font-size: 15px;
      color: #6c757d;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .countdown-timer {
      font-size: 36px;
      font-weight: 800;
      color: #28a745;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
      letter-spacing: 2px;
      text-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      margin: 20px 0;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #20c997);
      border-radius: 3px;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 30px 30px;
      animation: move 1s linear infinite;
    }

    @keyframes move {
      0% { background-position: 0 0; }
      100% { background-position: 30px 30px; }
    }

    .action-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 32px;
    }

    .btn {
      padding: 14px 28px;
      border-radius: 14px;
      text-decoration: none;
      font-weight: 600;
      font-size: 15px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.3px;
      min-width: 140px;
      justify-content: center;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: #fff;
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
      border: 2px solid transparent;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
    }

    .btn-primary:active {
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #fff;
      color: #495057;
      border: 2px solid #dee2e6;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .btn-secondary:hover {
      background: #f8f9fa;
      border-color: #28a745;
      color: #28a745;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .btn-icon {
      width: 18px;
      height: 18px;
      stroke-width: 2.5;
    }

    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-left: 4px solid #28a745;
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      max-width: 300px;
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .notification-text {
      font-size: 14px;
      color: #495057;
      margin: 0;
    }

    @media (max-width: 580px) {
      .verification-container {
        padding: 32px 24px;
        margin: 16px;
        border-radius: 20px;
      }

      .message-title {
        font-size: 24px;
      }

      .countdown-timer {
        font-size: 28px;
      }

      .action-buttons {
        flex-direction: column;
        gap: 12px;
      }

      .btn {
        width: 100%;
        padding: 16px 24px;
      }

      .notification {
        top: 16px;
        right: 16px;
        left: 16px;
        max-width: none;
        transform: translateY(-100px);
      }

      .notification.show {
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeInUp {
      from { 
        opacity: 0; 
        transform: translateY(30px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }

    /* Focus styles for accessibility */
    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="verification-container fade-in" id="verificationBox">
    <div class="brand-logo">
      <div class="logo-icon">S</div>
      Salmart
    </div>

    <div class="status-icon loading" id="statusIcon">
      <div class="spinner"></div>
    </div>

    <h1 class="message-title" id="messageTitle">Verifying Your Email</h1>
    <p class="message-description" id="messageDescription">Please wait while we verify your email address...</p>

    <div class="progress-bar" id="progressBar" style="display: none;">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE_URL = window.API_BASE_URL ||
      (window.location.hostname === 'localhost'
        ? 'http://localhost:3000'
        : 'https://salmart.onrender.com');

    const REDIRECT_DELAY = 5; // seconds
    const LOGIN_URL = 'SignIn.html';

    // DOM Elements
    const verificationBox = document.getElementById('verificationBox');
    const statusIcon = document.getElementById('statusIcon');
    const messageTitle = document.getElementById('messageTitle');
    const messageDescription = document.getElementById('messageDescription');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');

    // Get token from URL
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    // Utility function to create SVG icons
    function createIcon(type) {
      const icons = {
        check: `<svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
        </svg>`,
        x: `<svg class="x-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
        </svg>`,
        alert: `<svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>`,
        login: `<svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
        </svg>`,
        refresh: `<svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>`,
        close: `<svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
        </svg>`
      };
      return icons[type] || '';
    }

    // Show notification
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.innerHTML = `<p class="notification-text">${message}</p>`;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 400);
      }, 3000);
    }

    // Show error state
    function showError(title, description) {
      statusIcon.className = 'status-icon error';
      statusIcon.innerHTML = createIcon('alert');
      messageTitle.textContent = title;
      messageDescription.textContent = description;
      
      // Hide progress bar
      progressBar.style.display = 'none';

      // Add action buttons
      setTimeout(() => {
        const actionButtons = document.createElement('div');
        actionButtons.className = 'action-buttons';
        actionButtons.innerHTML = `
          <button class="btn btn-secondary" onclick="location.reload()">
            ${createIcon('refresh')}
            Try Again
          </button>
          <a href="${LOGIN_URL}" class="btn btn-primary">
            ${createIcon('login')}
            Go to Login
          </a>
        `;
        verificationBox.appendChild(actionButtons);
        
        showNotification('Verification failed. Please try again or contact support.', 'error');
      }, 600);
    }

    // Show success state with countdown
    function showSuccess(message) {
      statusIcon.className = 'status-icon success';
      statusIcon.innerHTML = createIcon('check');
      messageTitle.textContent = 'Email Verified Successfully!';
      messageDescription.textContent = message;

      // Show redirect info with countdown
      const redirectInfo = document.createElement('div');
      redirectInfo.className = 'redirect-info';
      redirectInfo.innerHTML = `
        <p class="redirect-text">Redirecting to login page in:</p>
        <div class="countdown-timer" id="countdownTimer">${REDIRECT_DELAY}</div>
      `;

      verificationBox.insertBefore(redirectInfo, progressBar);
      progressBar.style.display = 'block';

      // Action buttons
      const actionButtons = document.createElement('div');
      actionButtons.className = 'action-buttons';
      actionButtons.innerHTML = `
        <a href="${LOGIN_URL}" class="btn btn-primary">
          ${createIcon('login')}
          Login Now
        </a>
        <button class="btn btn-secondary" onclick="cancelRedirect()">
          ${createIcon('close')}
          Cancel
        </button>
      `;
      verificationBox.appendChild(actionButtons);

      showNotification('Email verified successfully! Redirecting to login...', 'success');
      
      // Start countdown immediately
      startCountdown();
    }

    // Countdown and redirect functionality
    let countdownInterval;
    let redirectTimeout;

    function startCountdown() {
      let timeLeft = REDIRECT_DELAY;
      const countdownTimer = document.getElementById('countdownTimer');

      // Update immediately
      if (countdownTimer) {
        countdownTimer.textContent = timeLeft;
      }
      progressFill.style.width = '0%';

      countdownInterval = setInterval(() => {
        timeLeft--;
        
        if (countdownTimer) {
          countdownTimer.textContent = timeLeft;
        }

        // Update progress bar
        const progress = ((REDIRECT_DELAY - timeLeft) / REDIRECT_DELAY) * 100;
        progressFill.style.width = progress + '%';

        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          clearTimeout(redirectTimeout);
          
          // Show redirect notification
          showNotification('Redirecting to login page...', 'success');
          
          // Redirect after a brief delay
          setTimeout(() => {
            window.location.href = LOGIN_URL;
          }, 500);
        }
      }, 1000);

      // Backup redirect timeout
      redirectTimeout = setTimeout(() => {
        clearInterval(countdownInterval);
        window.location.href = LOGIN_URL;
      }, (REDIRECT_DELAY + 1) * 1000);
    }

    // Cancel redirect function
    window.cancelRedirect = function() {
      clearInterval(countdownInterval);
      clearTimeout(redirectTimeout);

      const redirectInfo = document.querySelector('.redirect-info');
      if (redirectInfo) redirectInfo.remove();
      
      progressBar.style.display = 'none';
      messageDescription.textContent = 'Auto-redirect cancelled. You can login manually when ready.';

      // Update action buttons
      const actionButtons = document.querySelector('.action-buttons');
      if (actionButtons) {
        actionButtons.innerHTML = `
          <a href="${LOGIN_URL}" class="btn btn-primary">
            ${createIcon('login')}
            Go to Login
          </a>
        `;
      }

      showNotification('Auto-redirect cancelled.', 'success');
    };

    // Main verification logic
    async function verifyEmail() {
      try {
        // Initial loading state
        statusIcon.className = 'status-icon loading';
        statusIcon.innerHTML = '<div class="spinner"></div>';
        messageTitle.textContent = 'Verifying Your Email';
        messageDescription.textContent = 'Please wait while we verify your email address...';

        // Check if token exists
        if (!token) {
          setTimeout(() => {
            showError(
              'Invalid Verification Link',
              'No verification token found in the URL. Please check your email for the correct verification link.'
            );
          }, 1500);
          return;
        }

        // Update loading message
        setTimeout(() => {
          messageDescription.textContent = 'Connecting to verification server...';
        }, 800);

        // Make API request
        const response = await fetch(`${API_BASE_URL}/verify-email?token=${encodeURIComponent(token)}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });

        let data;
        try {
          data = await response.json();
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          data = { message: 'Invalid server response' };
        }

        if (response.ok) {
          // Success case
          setTimeout(() => {
            showSuccess(data.message || 'Your email has been verified successfully! You can now sign in to your account.');
          }, 500);
        } else {
          // Handle specific error cases based on status code
          let errorTitle = 'Verification Failed';
          let errorDescription = data.message || 'Unable to verify your email address. Please try again.';

          switch (response.status) {
            case 400:
              errorTitle = 'Invalid Request';
              errorDescription = 'The verification request is invalid. Please check the link and try again.';
              break;
            case 404:
              errorTitle = 'Token Not Found';
              errorDescription = 'This verification link is invalid or has expired. Please request a new verification email.';
              break;
            case 410:
              errorTitle = 'Link Expired';
              errorDescription = 'This verification link has expired. Please request a new verification email.';
              break;
            case 409:
              errorTitle = 'Already Verified';
              errorDescription = 'This email address has already been verified. You can proceed to login.';
              break;
            case 500:
              errorTitle = 'Server Error';
              errorDescription = 'A server error occurred. Please try again later or contact support.';
              break;
          }

          setTimeout(() => {
            showError(errorTitle, errorDescription);
          }, 1000);
        }

      } catch (error) {
        console.error('Verification error:', error);
        
        let errorTitle = 'Connection Failed';
        let errorDescription = 'Unable to connect to the verification server. Please check your internet connection and try again.';
        
        // Handle different types of network errors
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          errorDescription = 'Network error occurred. Please check your internet connection and try again.';
        } else if (error.message.includes('timeout')) {
          errorDescription = 'Request timed out. Please check your connection and try again.';
        }

        setTimeout(() => {
          showError(errorTitle, errorDescription);
        }, 1000);
      }
    }

    // Initialize verification on page load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded, starting verification...');
      console.log('Token:', token ? 'Present' : 'Missing');
      console.log('API URL:', API_BASE_URL);
      
      // Start verification process
      verifyEmail();
    });

    // Handle page visibility changes (prevent issues when user switches tabs)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && countdownInterval) {
        // Page is hidden, don't clear intervals but log it
        console.log('Page hidden during countdown');
      }
    });

    // Handle network status changes
    window.addEventListener('online', () => {
      showNotification('Connection restored', 'success');
    });

    window.addEventListener('offline', () => {
      showNotification('Connection lost. Please check your internet.', 'error');
    });
  </script>
</body>
</html>