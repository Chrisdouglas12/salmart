<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Chat - SALMART</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="Chats.css">   
</head>
<body>
  <div class="chats-header">
    <div class="user-profile">
      <img id="chatspic">
      <div class="user-info">
        <div id="chats-userName">Username</div>
        <div class="typing-indicator" id="typing-indicator"></div>
      </div>
    </div>
    <div class="chat-options">
      <i class="fas fa-ellipsis-v" id="ellipsis-btn"></i>
      <div id="chat-dropdown" class="dropdown-menu">
        <div class="dropdown-item" onclick="blockUser()">
          <i class="fas fa-user-slash"></i> Block User
        </div>
        <div class="dropdown-item" onclick="reportUser()">
          <i class="fas fa-flag"></i> Report User
        </div>
      </div>
    </div>
  </div>

  <div id="chat-messages"></div>

  <div class="message-container">
    <div id="image-preview-container" style="display: none;">
      <img id="image-preview" src="" alt="Image Preview">
      <div class="preview-actions">
        <label class="view-once-label">
          <input type="checkbox" id="view-once-toggle"> View Once
        </label>
        <button id="close-image-preview" class="close-preview-btn">&times;</button>
      </div>
    </div>
    
    <div class="input-section">
      <textarea id="type-section" placeholder="Type a message..." rows="1"></textarea>
      <div class="action-buttons">
        <div class="left-buttons">
          <input type="file" id="image-input" accept="image/*" style="display: none;">
          <button id="attach-btn" class="action-btn" title="Attach Image">
            <i class="fas fa-paperclip"></i>
          </button>
          <button id="emoji-btn" class="action-btn" title="Add Emoji">
            <i class="fas fa-smile"></i>
          </button>
          <button id="bargain-btn" class="action-btn" title="Start Bargaining">
            <i class="fas fa-handshake"></i>
          </button>
        </div>
        <div class="right-buttons">
          <button id="send-btn" class="action-btn primary" title="Send Message">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
      
      <div id="emoji-picker" class="emoji-picker">
        <div class="emoji-categories">
          <button class="emoji-category active" data-category="smileys">üòä</button>
          <button class="emoji-category" data-category="people">üëç</button>
          <button class="emoji-category" data-category="animals">üê∂</button>
          <button class="emoji-category" data-category="food">üçï</button>
          <button class="emoji-category" data-category="activities">‚öΩ</button>
          <button class="emoji-category" data-category="travel">üöó</button>
          <button class="emoji-category" data-category="objects">üíª</button>
          <button class="emoji-category" data-category="symbols">‚ù§Ô∏è</button>
        </div>
        <div class="emoji-grid" id="emoji-grid"></div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="reportConfirmationModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-flag"></i> Report User</h3>
      <p id="reportConfirmationText">Please provide a reason for reporting this user:</p>
      <textarea id="reportReason" placeholder="Describe the issue..." style="width: 100%; height: 100px; margin: 16px 0; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; resize: vertical;"></textarea>
      <div style="text-align: right; margin-top: 16px;">
        <button id="cancelReportBtn" class="btn btn-secondary">Cancel</button>
        <button id="confirmReportBtn" class="btn btn-primary">Submit Report</button>
      </div>
    </div>
  </div>

  <div id="blockConfirmationModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-user-slash"></i> Block User</h3>
      <p id="blockConfirmationText">Are you sure you want to block this user? You won't receive any more messages from them.</p>
      <div style="text-align: right; margin-top: 16px;">
        <button id="cancelBlockBtn" class="btn btn-secondary">Cancel</button>
        <button id="confirmBlockBtn" class="btn btn-danger">Yes, Block</button>
      </div>
    </div>
  </div>

  <div id="bargainModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-handshake"></i> Select a Product to Bargain</h3>
      <div id="bargainProductsContainer">
        <div class="spinner"></div>
        <p style="text-align: center; color: #64748b;">Loading products...</p>
      </div>
      <div style="text-align: right; margin-top: 16px;">
        <button class="btn btn-secondary" onclick="closeBargainModal()">Close</button>
      </div>
    </div>
  </div>

  <div id="updateStatusModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <div id="updateSpinner" class="spinner"></div>
      <div id="successIcon" style="display: none; font-size: 48px; color: #28a756; margin-bottom: 16px;">
        <i class="fas fa-check-circle"></i>
      </div>
      <div id="updateStatusText" style="color: #4a5568; margin-bottom: 16px;">Updating price...</div>
      <button id="statusActionBtn" class="btn btn-primary" style="display: none;">OK</button>
    </div>
  </div>

  <div id="acceptConfirmationModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-check-circle"></i> Confirm Price Acceptance</h3>
      <p id="confirmationMessage">Are you sure you want to accept this price?</p>
      <div style="text-align: right; margin-top: 16px;">
        <button id="cancelAcceptBtn" class="btn btn-secondary">No, Cancel</button>
        <button id="confirmAcceptBtn" class="btn btn-primary">Yes, Accept</button>
      </div>
    </div>
  </div>

  <div id="lastPriceModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-tag"></i> Enter Your Final Price</h3>
      <input type="number" id="lastPriceInput" placeholder="Enter your final price" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; margin: 16px 0;">
      <div style="text-align: right; margin-top: 16px;">
        <button id="closeLastPriceModalBtn" class="btn btn-secondary" onclick="closeLastPriceModal()">Close</button>
        <button id="submitLastPriceBtn" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const typeSection = document.getElementById('type-section');
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiGrid = document.getElementById('emoji-grid');
    const emojiBtn = document.getElementById('emoji-btn');
    const chatMessages = document.getElementById('chat-messages');
    const sendBtn = document.getElementById('send-btn');
    const attachBtn = document.getElementById('attach-btn');
    const imageInput = document.getElementById('image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const closeImagePreview = document.getElementById('close-image-preview');
    
    // Emoji data
    const emojiData = {
      smileys: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤'],
      people: ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','üëä','‚úä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü´Ä','ü´Å','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è','üëÖ','üëÑ','üíã'],
      animals: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üêª‚Äç‚ùÑÔ∏è','üê®','üêØ','ü¶Å','üêÆ','üê∑','üêΩ','üê∏','üêµ','üôà','üôâ','üôä','üêí','üêî','üêß','üê¶','üê§','üê£','üê•','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü','ü¶ó','üï∑Ô∏è','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','ü¶ô','üêê','ü¶å','üêï','üê©','ü¶Æ','üêï‚Äçü¶∫','üêà','üêà‚Äç‚¨õ','üêì','ü¶É','ü¶ö','ü¶ú','ü¶¢','ü¶©','üïäÔ∏è','üêá','ü¶ù','ü¶®','ü¶°','ü¶¶','ü¶•','üêÅ','üêÄ','üêøÔ∏è','ü¶î'],
      food: ['üçè','üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂Ô∏è','ü´ë','üåΩ','ü•ï','ü´í','üßÑ','üßÖ','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü','üçï','ü´ì','ü•™','ü•ô','üßÜ','üåÆ','üåØ','ü´î','ü•ó','ü•ò','ü´ï','ü•´','üçù','üçú','üç≤','üçõ','üç£','üç±','ü•ü','ü¶™','üç§','üçô','üçö','üçò','üç•','ü•†','ü•Æ','üç¢','üç°','üçß','üç®','üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','üå∞','ü•ú','üçØ'],
      activities: ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','ü™Ä','üèì','üè∏','üèí','üèë','ü•ç','üèè','ü™É','ü•Ö','‚õ≥','ü™Å','üèπ','üé£','ü§ø','ü•ä','ü•ã','üéΩ','üõπ','üõ∑','‚õ∏Ô∏è','ü•å','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è‚Äç‚ôÄÔ∏è','üèãÔ∏è','üèãÔ∏è‚Äç‚ôÇÔ∏è','ü§º‚Äç‚ôÄÔ∏è','ü§º','ü§º‚Äç‚ôÇÔ∏è','ü§∏‚Äç‚ôÄÔ∏è','ü§∏','ü§∏‚Äç‚ôÇÔ∏è','‚õπÔ∏è‚Äç‚ôÄÔ∏è','‚õπÔ∏è','‚õπÔ∏è‚Äç‚ôÇÔ∏è','ü§∫','ü§æ‚Äç‚ôÄÔ∏è','ü§æ','ü§æ‚Äç‚ôÇÔ∏è','üèåÔ∏è‚Äç‚ôÄÔ∏è','üèåÔ∏è','üèåÔ∏è‚Äç‚ôÇÔ∏è','üèá','üßò‚Äç‚ôÄÔ∏è','üßò','üßò‚Äç‚ôÇÔ∏è','üèÑ‚Äç‚ôÄÔ∏è','üèÑ','üèÑ‚Äç‚ôÇÔ∏è','üèä‚Äç‚ôÄÔ∏è','üèä','üèä‚Äç‚ôÇÔ∏è','ü§Ω‚Äç‚ôÄÔ∏è','ü§Ω','ü§Ω‚Äç‚ôÇÔ∏è','üö£‚Äç‚ôÄÔ∏è','üö£','üö£‚Äç‚ôÇÔ∏è','üßó‚Äç‚ôÄÔ∏è','üßó','üßó‚Äç‚ôÇÔ∏è','üöµ‚Äç‚ôÄÔ∏è','üöµ','üöµ‚Äç‚ôÇÔ∏è','üö¥‚Äç‚ôÄÔ∏è','üö¥','üö¥‚Äç‚ôÇÔ∏è','üèÜ','ü•á','ü•à','ü•â','üèÖ','üéñÔ∏è','üèµÔ∏è','üéóÔ∏è','üé´','üéüÔ∏è','üé™','ü§π','ü§π‚Äç‚ôÄÔ∏è','ü§π‚Äç‚ôÇÔ∏è','üé≠','ü©∞','üé®','üé¨','üé§','üéß','üéº','üéµ','üé∂','ü•Å','ü™ò','üéπ','üé∑','üé∫','üé∏','ü™ï','üéª','üé≤','‚ô†Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è','‚ôüÔ∏è','üÉè','üÄÑ','üé¥'],
      travel: ['üöó','üöï','üöô','üöå','üöé','üèéÔ∏è','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','üèçÔ∏è','üõµ','üö≤','üõ¥','üõπ','üõº','üöÅ','üõ∏','üöÄ','‚úàÔ∏è','üõ©Ô∏è','üõ´','üõ¨','ü™Ç','üí∫','üö¢','üõ•Ô∏è','üö§','‚õµ','üõ∂','‚öì','üöß','‚õΩ','üö®','üö•','üö¶','üõë','üöè','‚≠ê','üé°','üé¢','üé†','üèóÔ∏è','üåÅ','üóº','üè≠','‚õ≤','üéë','‚õ∞Ô∏è','üèîÔ∏è','üóª','üåã','üèïÔ∏è','üèñÔ∏è','üèúÔ∏è','üèùÔ∏è','üèûÔ∏è','üèüÔ∏è','üèõÔ∏è','üèóÔ∏è','üß±','ü™®','ü™µ','üõñ','üèòÔ∏è','üèöÔ∏è','üè†','üè°','üè¢','üè£','üè§','üè•','üè¶','üè®','üè©','üè™','üè´','üè¨','üè≠','üèØ','üè∞','üóæ','üéå','üèÅ','üö©','üè¥','üè≥Ô∏è','üè≥Ô∏è‚Äçüåà','üè≥Ô∏è‚Äç‚ößÔ∏è','üè¥‚Äç‚ò†Ô∏è'],
      objects: ['‚åö','üì±','üì≤','üíª','‚å®Ô∏è','üñ•Ô∏è','üñ®Ô∏è','üñ±Ô∏è','üñ≤Ô∏è','üïπÔ∏è','üóúÔ∏è','üíΩ','üíæ','üíø','üìÄ','üìº','üì∑','üì∏','üìπ','üé•','üìΩÔ∏è','üéûÔ∏è','üìû','‚òéÔ∏è','üìü','üì†','üì∫','üìª','üéôÔ∏è','üéöÔ∏è','üéõÔ∏è','üß≠','‚è±Ô∏è','‚è≤Ô∏è','‚è∞','üï∞Ô∏è','‚åõ','‚è≥','üì°','üîã','üîå','üí°','üî¶','üïØÔ∏è','ü™î','üßØ','üõ¢Ô∏è','üí∏','üíµ','üí¥','üí∂','üí∑','üí∞','üí≥','üíé','‚öñÔ∏è','üß∞','üîß','üî®','‚öíÔ∏è','üõ†Ô∏è','‚õèÔ∏è','üî©','‚öôÔ∏è','üß±','‚õìÔ∏è','üß≤','üî´','üí£','üß®','ü™ì','üî™','üó°Ô∏è','‚öîÔ∏è','üõ°Ô∏è','üö¨','‚ö∞Ô∏è','ü™¶','‚ö±Ô∏è','üè∫','üîÆ','üìø','üßø','üíà','‚öóÔ∏è','üî≠','üî¨','üï≥Ô∏è','ü©π','ü©∫','üíä','üíâ','üß¨','ü¶†','üß´','üß™','üå°Ô∏è','üßπ','üß∫','üßª','üöΩ','üö∞','üöø','üõÅ','üõÄ','üßº','ü™•','ü™í','üß¥','üß∑','üß∏','ü™Ü','üñºÔ∏è','üõçÔ∏è','üõí','üéÅ','üéÄ','üéä','üéâ','üéà','üéÇ','üçæ','ü•Ç','üçª','üç∑','ü•É','üç∏','üçπ','üßÉ','üßâ','‚òï','üçµ','ü•§','üßã','üçº','ü•õ','üçØ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','üå∞','ü•ú','ü´ê','üçá','üçà','üçâ','üçä','üçã','üçå','üçç','ü•≠','üçé','üçè','üçê','üçë','üçí','üçì','ü´í','ü•ù','üçÖ'],
      symbols: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚úùÔ∏è','‚ò™Ô∏è','üïâÔ∏è','‚ò∏Ô∏è','‚ú°Ô∏è','üîØ','üïé','‚òØÔ∏è','‚ò¶Ô∏è','üõê','‚õé','‚ôà','‚ôâ','‚ôä','‚ôã','‚ôå','‚ôç','‚ôé','‚ôè','‚ôê','‚ôë','‚ôí','‚ôì','üÜî','‚öõÔ∏è','üâë','‚ò¢Ô∏è','‚ò£Ô∏è','üì¥','üì≥','üà∂','üàö','üà∏','üà∫','üà∑Ô∏è','‚ú¥Ô∏è','üÜö','üíÆ','üâê','„äôÔ∏è','„äóÔ∏è','üà¥','üàµ','üàπ','üà≤','üÖ∞Ô∏è','üÖ±Ô∏è','üÜé','üÜë','üÖæÔ∏è','üÜò','‚ùå','‚≠ï','üõë','‚õî','üìõ','üö´','üíØ','üí¢','‚ô®Ô∏è','üö∑','üöØ','üö≥','üö±','üîû','üìµ','üö≠','‚ùó','‚ùï','‚ùì','‚ùî','‚ÄºÔ∏è','‚ÅâÔ∏è','üîÖ','üîÜ','„ÄΩÔ∏è','‚ö†Ô∏è','üö∏','üî±','‚öúÔ∏è','üî∞','‚ôªÔ∏è','‚úÖ','üàØ','üíπ','‚ùáÔ∏è','‚ú≥Ô∏è','‚ùé','üåê','üí†','‚ìÇÔ∏è','üåÄ','üí§','üèß','üöæ','‚ôø','üÖøÔ∏è','üõó','üà≥','üàÇÔ∏è','üõÇ','üõÉ','üõÑ','üõÖ','üöπ','üö∫','üöº','‚ößÔ∏è','üöª','üöÆ','üé¶','üì∂','üàÅ','üî£','‚ÑπÔ∏è','üî§','üî°','üî†','üÜñ','üÜó','üÜô','üÜí','üÜï','üÜì','0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü']
    };

    // Initialize variables
    let currentCategory = 'smileys';
    let isKeyboardOpen = false;
    let initialViewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    let keyboardTimeout;

    // Textarea auto-resize function
    function autoResizeTextarea() {
      typeSection.style.height = 'auto';
      typeSection.style.height = Math.min(typeSection.scrollHeight, 200) + 'px';
    }

    // Event listeners for textarea
    typeSection.addEventListener('input', function() {
      autoResizeTextarea();
      sendTypingSignal();
    });

    typeSection.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Initial resize
    autoResizeTextarea();

    // Emoji picker functionality
    emojiBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
      if (emojiPicker.style.display === 'block') {
        loadEmojiCategory(currentCategory);
      }
    });

    document.addEventListener('click', function(e) {
  if (!emojiPicker.contains(e.target)) {  // Added missing closing parenthesis
    emojiPicker.style.display = 'none';
  }
});

    document.querySelectorAll('.emoji-category').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelector('.emoji-category.active').classList.remove('active');
        this.classList.add('active');
        currentCategory = this.dataset.category;
        loadEmojiCategory(currentCategory);
      });
    });

    function loadEmojiCategory(category) {
      const emojis = emojiData[category] || [];
      let html = '';
        
      for (let i = 0; i < emojis.length; i += 9) {
        html += '<div class="emoji-row">';
        for (let j = i; j < i + 9 && j < emojis.length; j++) {
          html += `<button class="emoji-item" data-emoji="${emojis[j]}">${emojis[j]}</button>`;
        }
        html += '</div>';
      }
        
      emojiGrid.innerHTML = html;
        
      document.querySelectorAll('.emoji-item').forEach(item => {
        item.addEventListener('click', function() {
          insertEmoji(this.dataset.emoji);
        });
      });
    }

    function insertEmoji(emoji) {
      const start = typeSection.selectionStart;
      const end = typeSection.selectionEnd;
      const text = typeSection.value;
      typeSection.value = text.substring(0, start) + emoji + text.substring(end);
      typeSection.selectionStart = typeSection.selectionEnd = start + emoji.length;
      typeSection.focus();
      autoResizeTextarea();
      emojiPicker.style.display = 'none';
    }

    function isEmojiOnly(text) {
      const emojiRegex = /^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]+$/u;
      return emojiRegex.test(text.trim());
    }

    // Image attachment functionality
    attachBtn.addEventListener('click', () => imageInput.click());
    
    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          imagePreview.src = event.target.result;
          imagePreviewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    closeImagePreview.addEventListener('click', function() {
      imagePreviewContainer.style.display = 'none';
      imagePreview.src = '';
      imageInput.value = '';
    });

    // Keyboard handling
    function handleViewportChange() {
      const currentHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      const heightDifference = initialViewportHeight - currentHeight;
        
      clearTimeout(keyboardTimeout);
        
      if (heightDifference > 150) {
        if (!isKeyboardOpen) {
          isKeyboardOpen = true;
          document.body.classList.add('typing');
          const header = document.querySelector('.chats-header');
          if (header) {
            header.style.position = 'fixed';
            header.style.top = '0';
            header.style.zIndex = '9999';
          }
          setTimeout(() => {
            if (chatMessages) {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          }, 100);
        }
      } else {
        keyboardTimeout = setTimeout(() => {
          if (isKeyboardOpen) {
            isKeyboardOpen = false;
            document.body.classList.remove('typing');
            initialViewportHeight = currentHeight;
          }
        }, 150);
      }
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', handleViewportChange);
      window.visualViewport.addEventListener('scroll', handleViewportChange);
    } else {
      window.addEventListener('resize', handleViewportChange);
    }

    typeSection.addEventListener('focus', function() {
      document.body.classList.add('typing');
      setTimeout(() => {
        if (document.activeElement === typeSection) {
          document.body.classList.add('typing');
          isKeyboardOpen = true;
          const header = document.querySelector('.chats-header');
          if (header) {
            header.style.position = 'fixed';
            header.style.top = '0';
          }
          if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }
      }, 300);
    });

    typeSection.addEventListener('blur', function() {
      setTimeout(() => {
        if (document.activeElement !== typeSection) {
          const currentHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
          if (initialViewportHeight - currentHeight <= 150) {
            document.body.classList.remove('typing');
            isKeyboardOpen = false;
            initialViewportHeight = currentHeight;
          }
        }
      }, 200);
    });

    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        initialViewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
        document.body.classList.remove('typing');
        isKeyboardOpen = false;
      }, 500);
    });

    // Device-specific fixes
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      typeSection.addEventListener('touchstart', function() {
        if (typeSection.style.fontSize !== '16px') {
          typeSection.style.fontSize = '16px';
        }
      });
        
      window.addEventListener('resize', function() {
        if (window.innerHeight < initialViewportHeight * 0.75) {
          document.body.classList.add('typing');
          isKeyboardOpen = true;
        }
      });
    }

    if (/Android/.test(navigator.userAgent)) {
      let androidInitialHeight = window.innerHeight;
      window.addEventListener('resize', function() {
        const currentHeight = window.innerHeight;
        const ratio = currentHeight / androidInitialHeight;
        if (ratio < 0.75) {
          document.body.classList.add('typing');
          isKeyboardOpen = true;
        } else if (ratio > 0.9) {
          document.body.classList.remove('typing');
          isKeyboardOpen = false;
        }
      });
    }

    // Initialize header position
    document.addEventListener('DOMContentLoaded', function() {
      const header = document.querySelector('.chats-header');
      if (header) {
        header.style.position = 'fixed';
        header.style.top = '0';
        header.style.zIndex = '9999';
        header.style.width = '100%';
      }
    });

    // Placeholder functions for other features
    function sendTypingSignal() {
      // Implement typing indicator logic
    }

    function blockUser() {
      document.getElementById('blockConfirmationModal').style.display = 'block';
    }

    function reportUser() {
      document.getElementById('reportConfirmationModal').style.display = 'block';
    }

    function closeBargainModal() {
      document.getElementById('bargainModal').style.display = 'none';
    }

    function closeLastPriceModal() {
      document.getElementById('lastPriceModal').style.display = 'none';
    }
  </script>

  <script type="module" src="./scripts/Chats.js"></script>
  <script src="./scripts/sw-update-manager.js"></script>
</body>
</html>