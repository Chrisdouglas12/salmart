<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home | Salmart</title>
    <link rel="stylesheet" href="./Style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Serif+Display:ital@0;1&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <script src="addPic.js"></script>
</head>
<body>
  <div class="Genenral-container">
    <div class="loader" id="loader"></div>
    <div class="menu-icon">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="profile-pic">
      <img src="Default.png" alt="up" id="profile-picture3" width="40px" height="40px" style="border-radius: 50%">
    </div>
    <div style="text-align:center">
      <div style="z-index: 3; position: fixed; margin-left: 83.5%; margin-top: 16px; font-size: 16px;">
        <a href="Search.html">
          <i class="fas fa-search" style="color:#28a745; border: 0.1px solid #fff; border-radius: 20px; padding: 8.5px; background-color:#fff; box-shadow: 0 0 10px #ddd; font-weight: light; margin-left: auto"></i>
        </a>
      </div>
      <h2 class="head" style="color: #28a745; background-color: white; padding-top: 20px; padding-bottom: 20px; margin-top: -0px; box-shadow: 0 0px 10px 0px #d3d3d3; border: solid; border-width: 1px; border-color: #fff; position: fixed; z-index:1; width: 100vw; font-size: 19px; font-family: Poppins">Salmart</h2> 
    </div>

    <div style="text-align: center">
      <!-- Delete Confirmation Modal -->
      <div id="delete-modal" class="modern-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Confirm Deletion</h3>
            <button class="close-modal">×</button>
          </div>
          <div class="modal-body">
            <div class="modal-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#e74c3c">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
              </svg>
            </div>
            <p>Are you sure you want to delete this Ad?</p>
            <p class="secondary-text">This action cannot be undone and the Ad will be permanently removed.</p>
          </div>
          <div class="modal-footer">
            <button id="cancel-delete" class="secondary-button">Cancel</button>
            <button id="confirm-delete" class="danger-button">
              <span class="button-loader" id="delete-loader"></span>
              <span class="button-text">Delete</span>
            </button>
          </div>
        </div>
      </div>
      <nav id="navbar">
        <ul>
          <li class="active"><a href="index.html"><i class="fas fa-store"></i>Market</a></li>
          <li class="active"><a href="requestlists.html"><i class="fas fa-clipboard-list"></i>Requests</a></li>
          <li><a href="Alerts.html" onclick="clearBadge('alerts')"><i class="fas fa-bell"></i>Alerts <span class="notification-badge" id="alerts-badge"></span></a></li>
          <li><a href="Messages.html" onclick="clearBadge('messages')"><i class="fas fa-comments"></i>Messages <span class="notification-badge" id="messages-badge"></span></a></li> 
          <li><a href="Deals.html" onclick="clearBadge('deals')"><i class="fas fa-cart-plus"></i>Deals <span class="notification-badge" id="deals-badge"></span></a></li>
          <li><a href="Profile.html"><i class="fas fa-user"></i>Profile</a></li>
        </ul>
      </nav>
      <!-- Toast Notification -->
      <div id="toast" style="display: none; position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); padding: 5px; border-radius: 5px; color: #fff; z-index: 1000; font-size: 12px"></div>
    </div>
    <div class="side-bar">
      <div class="profile-sec">
        <img src="default-avatar.png" alt="pic" id="profile-picture1">
        <h1 id="username1">Username</h1>
      </div>
      <ul>
        <li><a href="index.html" class="active"><i class="fas fa-store"></i>Market</a></li>
        <li><a href="Alerts.html"><i class="fas fa-bell"></i> Alerts</a></li>
        <li><a href="Messages.html"><i class="fas fa-comment"></i>Messages</a></li> 
        <li><a href="Deals.html"><i class="fas fa-cart-plus"></i>Deals</a></li>
        <li><a href="Profile.html"><i class="fas fa-user"></i> Profile</a></li>
        <li><a href="Profile.html"><i class="fa-solid fa-user-tie"></i> Hire Skills</a></li>
        <li><a href="Profile.html"><i class="fa-solid fa-receipt"></i> Generate Receipts</a></li>
        <li><a href="Profile.html"><i class="fa-solid fa-lock"></i> Privacy Policy</a></li>
        <li><a href="Privacy.html"><i class="fa-solid fa-circle-info"></i> Community Standards</a></li>
        <li><a href="SignIn.html" id="logout-link"><i class="fas fa-sign-out-alt"></i> <span id="logout-text">Log out</span></a></li>
      </ul>
      <pre style="font-size: 10px; text-align: center; margin-top: 40px; color: green">©Salmart Technologies 2025</pre>
    </div>
    <div class="create-post-container">
      <div>
        <a href="Ads.html"><button class="post-input" style="background-color:#007bff; color: white; font-family: 'Poppins'; font-size: 12px"><i class="fas fa-bullhorn"></i> Create an ad</button></a>
        <a href="Request.html"><button class="post-input" style="background-color: #28a745; color: white; font-family: 'Poppins'; font-size: 12px">Create a request <i class="fas fa-circle-plus"></i></button></a>
      </div>
      <!-- Category Filter Section -->
      <div class="category-filter">
        <div class="category-scroll-wrapper">
          <div class="category-scroll">
            <button class="category-btn active" data-category="all"><i class="fas fa-layer-group"></i> All</button>
            <button class="category-btn" data-category="electronics"><i class="fas fa-tv"></i> Electronics</button>
            <button class="category-btn" data-category="fashion"><i class="fas fa-tshirt"></i> Fashion</button>
            <button class="category-btn" data-category="home"><i class="fas fa-tree"></i> Home & Garden</button>
            <button class="category-btn" data-category="vehicles"><i class="fas fa-car"></i> Vehicles</button>
            <button class="category-btn" data-category="music"><i class="fas fa-guitar"></i> Music Gear</button>
            <button class="category-btn" data-category="others"><i class="fas fa-box-open"></i> Other</button>
          </div>
        </div>
      </div> 
    </div>
    <div id="loader" style="display: none;">Loading...</div>
    <div>
      <div id="posts-container">
        <!-- Skeleton Loaders for Posts -->
        <div class="skeleton skeleton-post"></div>
        <div class="skeleton skeleton-post"></div>
        <div class="skeleton skeleton-post"></div>
      </div>
      <div class="request-feed-container">
        <div id="request-feed" class="request-feed">
          <!-- Requests will be dynamically injected here -->
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
      <span class="close">×</span>
      <img class="modal-content" id="fullImage">
    </div>
    <!-- Preview for additional images -->
    <div id="image-preview-container" style="display: flex; gap: 5px; margin-top: 10px;"></div>
    <!-- Image Gallery Modal -->
    <div id="galleryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center;">
      <div id="galleryContent" style="display: flex; flex-wrap: wrap; gap: 10px; max-width: 90%; max-height: 90%; overflow-y: auto;"></div>
    </div>

    <!-- Inline Scripts (unchanged except for relevant modifications) -->
    <script>
    const menuIcon = document.querySelector('.menu-icon');
    const sideBar = document.querySelector('.side-bar');
    const body = document.body;
    menuIcon.addEventListener('click', () => {
      sideBar.style.display = sideBar.style.display === 'block' ? 'none' : 'block';
      body.classList.toggle('no-scroll');
    });
    document.body.addEventListener('click', (e) => {
      if (sideBar.style.display === 'block' && !sideBar.contains(e.target) && !menuIcon.contains(e.target)) {
        sideBar.style.display = 'none';
        body.classList.remove('no-scroll');
      }
    });
    </script>
    <script>
    window.onload = function() {
      const isLoggedIn = localStorage.getItem('userId');
      const logoutText = document.getElementById('logout-text');
      const logoutLink = document.getElementById('logout-link');
      if (isLoggedIn) {
        logoutText.innerText = 'Log out';
        logoutLink.href = '#';
        logoutLink.addEventListener('click', function(event) {
          event.preventDefault();
          localStorage.removeItem('userId');
          window.location.href = 'SignIn.html';
        });
      } else {
        logoutText.innerText = 'Log in';
        logoutLink.href = 'SignIn.html';
      }
    };
    </script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://salmart-production.up.railway.app';
    const socket = io(`${API_BASE_URL}`, {
      path: '/socket.io',
      transports: ['websocket', 'polling']
    });
    socket.on('connect', () => {
      console.log('Connected to server');
    });
    </script>
    <script>
    function likePost(postId, userId) {
      socket.emit("like", { postId, userId });
    }
    function commentPost(postId, userId, comment) {
      socket.emit("comment", { postId, userId, comment });
    }
    </script>
    <script>
    socket.on("new-like", (data) => {
      console.log("New like:", data);
      alert(`User ${data.userId} liked post ${data.postId}`);
    });
    socket.on("new-comment", (data) => {
      console.log("New comment:", data);
      alert(`User ${data.userId} commented on post ${data.postId}: "${data.comment}"`);
    });
    </script>
    <script>
    function openImage(imageUrl) {
      const modal = document.getElementById("imageModal");
      const fullImage = document.getElementById("fullImage");
      fullImage.src = imageUrl;
      modal.style.display = "flex";
      modal.onclick = function (event) {
        if (event.target === modal || event.target.classList.contains("close")) {
          modal.style.display = "none";
        }
      };
    }
    </script>
    <script>
    function showToast(message, color = '#28a745') {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.backgroundColor = color;
      toast.style.display = "block";
      setTimeout(() => {
        toast.style.display = "none";
      }, 3000);
    }
    </script>
    <script>
    let currentCategory = 'all';
    let allPostsCache = [];
    document.addEventListener('DOMContentLoaded', function() {
      const categoryBtns = document.querySelectorAll('.category-btn');
      categoryBtns.forEach(btn => {
        btn.addEventListener('click', async function() {
          categoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentCategory = this.dataset.category;
          await fetchPostsByCategory();
        });
      });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const categoryFilter = document.querySelector('.category-filter');
      const header = document.querySelector('.head');
      const headerHeight = header.offsetHeight;
      const stickyPosition = 60;
      const spacer = document.createElement('div');
      spacer.style.height = categoryFilter.offsetHeight + 'px';
      spacer.style.display = 'none';
      categoryFilter.parentNode.insertBefore(spacer, categoryFilter.nextSibling);
      const initialTop = categoryFilter.getBoundingClientRect().top + window.scrollY;
      window.addEventListener('scroll', function() {
        const scrollY = window.scrollY || window.pageYOffset;
        if (scrollY >= initialTop - stickyPosition) {
          categoryFilter.style.position = 'fixed';
          categoryFilter.style.top = stickyPosition + 'px';
          categoryFilter.style.left = '0';
          categoryFilter.style.right = '0';
          categoryFilter.style.zIndex = '100';
          spacer.style.display = 'block';
        } else {
          categoryFilter.style.position = 'static';
          spacer.style.display = 'none';
        }
      });
      window.dispatchEvent(new Event('scroll'));
    });
    </script>
    <script>
    async function checkForNewContent() {
      try {
        const userId = localStorage.getItem('userId');
        if (!userId) return;
        const response = await fetch(`${API_BASE_URL}/notification-counts?userId=${userId}`);
        const data = await response.json();
        updateBadge('alerts-badge', data.alertsCount);
        updateBadge('messages-badge', data.messagesCount);
        updateBadge('deals-badge', data.dealsCount);
      } catch (error) {
        console.error('Error fetching notification counts:', error);
      }
    }
    function updateBadge(badgeId, count) {
      const badge = document.getElementById(badgeId);
      if (!badge) return;
      if (count > 0) {
        badge.style.display = 'inline-block';
        badge.textContent = count > 9 ? '9+' : count;
      } else {
        badge.style.display = 'none';
      }
    }
    setInterval(checkForNewContent, 30000);
    document.addEventListener('DOMContentLoaded', checkForNewContent);
    socket.on('new-notification', (data) => {
      if (data.type === 'alert') {
        updateBadge('alerts-badge', data.count);
      } else if (data.type === 'message') {
        updateBadge('messages-badge', data.count);
      } else if (data.type === 'deal') {
        updateBadge('deals-badge', data.count);
      }
    });
    </script>
    <script>
    socket.on("connect", () => {
      console.log("✅ Socket.IO connected with ID:", socket.id);
      const userId = localStorage.getItem("userId");
      if (userId) {
        console.log("👤 Registering user with Socket.IO:", userId);
        socket.emit("joinRoom", userId);
      } else {
        console.warn("⚠️ No userId found in localStorage");
      }
    });
    socket.on("disconnect", () => {
      console.log("❌ Socket.IO disconnected");
    });
    socket.on("connect_error", (error) => {
      console.error("🔥 Socket.IO connection error:", error);
    });
    function updateBadge(badgeId, count) {
      const badge = document.getElementById(badgeId);
      if (!badge) {
        console.error(`❌ Badge element not found: ${badgeId}`);
        return;
      }
      console.log(`🔄 Updating badge ${badgeId} with count:`, count);
      if (count > 0) {
        badge.style.display = "inline-block";
        badge.textContent = count > 9 ? "9+" : count;
      } else {
        badge.style.display = "none";
        badge.textContent = "0";
      }
    }
    async function clearBadge(type) {
      const badgeId = `${type}-badge`;
      const userId = localStorage.getItem("userId");
      const token = localStorage.getItem("authToken");
      if (!userId || !token) {
        console.warn("⚠️ User not logged in or no token found");
        return;
      }
      updateBadge(badgeId, 0);
      try {
        const response = await fetch(`${API_BASE_URL}/${type}/mark-as-viewed`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ userId }),
        });
        if (!response.ok) {
          throw new Error(`Failed to mark ${type} as viewed: ${response.status}`);
        }
        const data = await response.json();
        console.log(`✅ ${type} marked as viewed:`, data);
        socket.emit("badge-update", { type, count: 0, userId });
        await checkForNewContent();
      } catch (error) {
        console.error(`❌ Error clearing ${type} badge:`, error);
        checkForNewContent();
      }
    }
    async function checkForNewContent() {
      const userId = localStorage.getItem("userId");
      const token = localStorage.getItem("authToken");
      if (!userId || !token) return;
      try {
        const response = await fetch(`${API_BASE_URL}/notification-counts?userId=${userId}`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log("📊 Notification counts:", data);
        updateBadge("alerts-badge", data.alertsCount || 0);
        updateBadge("messages-badge", data.messagesCount || 0);
        updateBadge("deals-badge", data.dealsCount || 0);
      } catch (error) {
        console.error("💥 Error fetching notification counts:", error);
      }
    }
    socket.on("badge-update", (data) => {
      const userId = localStorage.getItem("userId");
      if (data.userId === userId) {
        console.log("📢 Received badge update:", data);
        updateBadge(`${data.type}-badge`, data.count);
      }
    });
    document.addEventListener("DOMContentLoaded", () => {
      console.log("🏁 Page loaded - initializing badges");
      checkForNewContent();
      setTimeout(() => {
        console.log("🔍 Badge elements:", {
          alerts: document.getElementById("alerts-badge"),
          messages: document.getElementById("messages-badge"),
          deals: document.getElementById("deals-badge"),
        });
      }, 1000);
    });
    setInterval(checkForNewContent, 30000);
    </script>
    <script>
    socket.on('notification', (data) => {
      console.log('Received notification:', data);
      showToast(`${data.sender.firstName} ${data.sender.lastName} ${data.type === 'like' ? 'liked' : 'commented on'} your post`, '#28a745');
    });
    socket.on('receiveMessage', (message) => {
      console.log('New message:', message);
      showToast(`New message from ${message.senderId}`, '#28a745');
    });
    function likePost(postId, userId) {
      socket.emit('likePost', { postId, userId });
    }
    function commentPost(postId, userId, comment) {
      socket.emit('commentPost', { postId, userId, comment });
    }
    function sendMessage(senderId, receiverId, text) {
      socket.emit('sendMessage', { senderId, receiverId, text });
    }
    function showToast(message, color = '#28a745') {
      const toast = document.getElementById("toast");
      if (!toast) {
        console.error('Toast element not found');
        return;
      }
      toast.textContent = message;
      toast.style.backgroundColor = color;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, 3000);
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <script type="module" src="firebase-app.js"></script>
    <script src="homeScript.js"></script>
  </div>
</body>
</html>