<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home | Salmart</title>

<link rel="stylesheet" href="./Style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
   <link rel="preconnect" href="https://fonts.googleapis.com">

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Serif+Display:ital@0;1&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <title>MarketPlace</title>

<script src="homeScript.js"></script>
<script src="addPic.js"></script>



</head>
<body>
  <div class="Genenral-container">
    <div class="loader" id="loader">

    </div>
<div class="menu-icon">
  <div></div>
  <div></div>
  <div></div>
</div>
<div class="profile-pic">
  <img src="Default.png" alt="up" id="profile-picture3" width="40px" height="40px" style="border-radius: 50%">
</div>


<div style="text-align:center">
  <div style="z-index: 3; position: fixed; margin-left: 83.5%; margin-top: 16px; font-size: 16px;">
    <a href="Search.html">
  <i class="fas fa-search" style="color:#28a745; border: 0.1px solid #fff; border-radius: 20px; padding: 8.5px; background-color:#fff; box-shadow: 0 0 10px #ddd; font-weight: light; margin-left: auto"></i>

  </a>
  </div>

  <h2 class="head" style=" color:  #28a745; background-color: white; padding-top: 20px; padding-bottom: 20px;  margin-top: -0px; box-shadow: 0 0px 10px 0px #d3d3d3; border: solid; border-width: 1px; border-color: #fff; position: fixed;  z-index:1; width: 100vw; font-size: 19px; font-family: Poppins">Salmart</h2> 
  </div>


  <div style="text-align: center">

    <!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modern-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Confirm Deletion</h3>
      <button class="close-modal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="modal-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#e74c3c">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
      </div>
      <p>Are you sure you want to delete this Ad?</p>
      <p class="secondary-text">This action cannot be undone and the Ad will be permanently removed.</p>
    </div>
    <div class="modal-footer">
      <button id="cancel-delete" class="secondary-button">Cancel</button>
      <button id="confirm-delete" class="danger-button">
        <span class="button-loader" id="delete-loader"></span>
        <span class="button-text">Delete</span>
      </button>
    </div>
  </div>
</div>
    <nav id="navbar">
  <ul>
    <li class="active"><a href="index.html"><i class="fas fa-store"></i>Market</a></li>
    <li><a href="Alerts.html" onclick="clearBadge('alerts')"><i class="fas fa-bell"></i>Alerts <span class="notification-badge" id="alerts-badge"></span></a></li>
    <li><a href="Messages.html" onclick="clearBadge('messages')"><i class="fas fa-comments"></i>Messages <span class="notification-badge" id="messages-badge"></span></a></li> 
    <li><a href="Deals.html" onclick="clearBadge('deals')"><i class="fas fa-cart-plus"></i>Deals <span class="notification-badge" id="deals-badge"></span></a></li>
    <li><a href="Profile.html"><i class="fas fa-user"></i>Profile</a></li>
  </ul>
</nav>

    <!-- toast notification -->
<div id="toast" style="display: none; position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); padding: 5px; border-radius: 5px; color: #fff; z-index: 1000; font-size: 12px"></div>


  </div>
  <div class="side-bar">
    <div class="profile-sec">
      <img src="default-avatar.png" alt="pic" id="profile-picture1">
      <h1 id="username1">Username</h1>
    </div>
    <ul>
      <li><a href="index.html" class="active"><i class="fas fa-store"></i>Market</a></li>
      <li><a href="Alerts.html"><i class="fas fa-bell"></i> Alerts</a></li>
      <li><a href="Messages.html"><i class="fas fa-comment"></i>Messages</a></li> 
            <li><a href="Deals.html"><i class="fas fa-cart-plus"></i>Deals</a></li>
      <li><a href="Profile.html"><i class="fas fa-user"></i> Profile</a></li>
       <li><a href="Profile.html"><i class="fa-solid fa-user-tie"></i> Hire Skills</a></li>
       <li><a href="Profile.html"><i class="fa-solid fa-receipt"></i> Generate Reciepts</a></li>
        <li><a href="Profile.html"><i class="fa-solid fa-lock"></i> Privacy Policy</a></li>
         <li><a href="Privacy.html"><i class="fa-solid fa-circle-info"></i> Community Standards</a></li>
<li><a href="SignIn.html" id="logout-link"><i class="fas fa-sign-out-alt"></i> <span id="logout-text">Log out</span></a></li>
    </ul>
    <pre style="font-size: 10px; text-align: center; margin-top: 40px; color: green">&copy;Salmart Technologies 2025</pre>
  </div>


 <div class="create-post-container">
     <div>
         <a href="Ads.html"><button class="post-input"  placeholder="Create an ad..." style="background-color:#007bff; color: white; font-family: 'Poppins'; font-size: 12px"> <i class="fas fa-bullhorn"></i> Create an ad</button></a>
                  <a href="Request.html"><button class="post-input" placeholder="Create a request..." style="background-color:  #28a745; color: white; font-family: 'Poppins'; font-size: 12px"> Create a request <i class="fas fa-circle-plus"></i></button></a>
          </div>
     <!-- Category Filter Section -->

<div class="category-filter">
       <div class="category-scroll-wrapper">
  <div class="category-scroll">
    <button class="category-btn active" data-category="all"> <i class="fas fa-layer-group"></i> All</button>
    <button class="category-btn" data-category="electronics"><i class="fas fa-tv"></i> Electronics</button>
    <button class="category-btn" data-category="fashion"> <i class="fas fa-tshirt"></i> Fashion</button>
    <button class="category-btn" data-category="home"> <i class="fas fa-tree"></i> Home & Garden</button>
    <button class="category-btn" data-category="vehicles"> <i class="fas fa-car"></i> Vehicles</button>
    <button class="category-btn" data-category="music"> <i class="fas fa-guitar"></i>  Music Gear</button>
    <button class="category-btn" data-category="others"> <i class="fas fa-box-open"></i> Other</button>
  </div>
</div>
 </div> 
 </div>
 <div id="loader" style="display: none;">Loading...</div>
  <div>
    <div id="posts-container"></div>
       <div class="request-feed-container">
  <div id="request-feed" class="request-feed">
    <!-- Requests will be dynamically injected here -->
  </div>
</div>
  </div>


<script>
const menuIcon = document.querySelector('.menu-icon');
const sideBar = document.querySelector('.side-bar');
const body = document.body;

menuIcon.addEventListener('click', () => {
  sideBar.style.display = sideBar.style.display === 'block' ? 'none' : 'block';
  body.classList.toggle('no-scroll');
});

document.body.addEventListener('click', (e) => {
  if (sideBar.style.display === 'block' && !sideBar.contains(e.target) && !menuIcon.contains(e.target)) {
    sideBar.style.display = 'none';
    body.classList.remove('no-scroll');
  }
});

</script>
<script>
window.onload = function() {
    const isLoggedIn = localStorage.getItem('userId');
    const logoutText = document.getElementById('logout-text');
    const logoutLink = document.getElementById('logout-link');

    if (isLoggedIn) {
        logoutText.innerText = 'Log out';
        logoutLink.href = '#';
        logoutLink.addEventListener('click', function(event) {
            event.preventDefault();
            localStorage.removeItem('userId');
            window.location.href = 'SignIn.html';
        });
    } else {
        logoutText.innerText = 'Log in';
        logoutLink.href = 'SignIn.html';
    }
};
</script>
<style>
*{
  margin: 0;
  padding: 0;
}
  .side-bar{
    display: none;
    position: fixed;
    top: 0px;
    left: 0;
    z-index: 20000;
    background-color: #fff;
    border: 1px #ddd solid;
    box-shadow: 0 0 10px #ddd;
    height: 100vh;
    width: 70%;
  }
  h1{
    margin: 20px 0px;
    margin-left: 5px;

  }
  .side-bar ul{
    list-style: none;
     margin: 0;
     padding: 0;
  padding-top: 20px;
  margin-left: 5px;

  }
  .side-bar li{
    margin-bottom: 10px;
    border: 0.1px solid #fff;
    padding: 10px;
    border-end-end-radius: 20px;
    background-color:  #fff;
    box-shadow: 0 0 10px #ddd;
    margin-right: 3px;
  }
  .side-bar .active{
    color:  #dd;
  }
  .side-bar a{
    text-decoration: none;
    color:  #28a745;
    padding-right: 10%;

  }
  .side-bar i{
    margin-right: 20px;

  }
.profile-sec {
  width: 100%; /* Ensures it spans the entire width of the sidebar */
  border-bottom: 0.1px solid #fff; /* The line at the bottom */
  padding-bottom: 5px;
  display: flex;
  box-sizing: border-box;
  box-shadow: 0 0 10px #ddd;
}

.profile-sec img {
  border: solid 0.1px #fff;
  box-shadow: 0 0 10px #ddd;
  border-radius: 100%;
  width: 45px; 
  height: 45px;
  margin-left: 5px;
  margin-top: 10px;
}
  no-scroll {
  overflow: hidden;
  position: fixed;
  width: 100%;
}
.menu-icon{
  color: #28a745;
}
a .active {
  color: blue;
}
/* Category Filter Styles */
.category-filter {
  top: 70px;
  z-index: 0;
  background-color: white;
  padding: 10px 0;
  max-width: 700px;
  border-bottom: 1px solid #eee;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.category-scroll {
  display: inline-flex;
  overflow-x: auto;
  gap: 8px;
  padding: 0 15px;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

.category-scroll::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

.category-btn {
  flex: 0 auto;
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid #e0e0e0;
  background-color: #f8f9fa;
  color: #333;
  font-size: 12px;
  font-family: 'Poppins', sans-serif;
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.category-btn:hover {
  background-color: #e9ecef;
}

.category-btn.active {
  background-color: #28a745;
  color: white;
  border-color: #28a745;
}
.category-scroll-wrapper{
  display: flex;
  justify-content: center;
  overflow-x: auto;
}


</style>
<!-- Load Socket.IO from CDN -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const API_BASE_URL = window.location.hostname === 'localhost' 
  ? 'http://localhost:3000' 
  : 'https://salmart-production.up.railway.app';
  // Connect to your backend (replace with actual URL)
  const socket = io(`${API_BASE_URL}`,
   {
    path: '/socket.io',
    transports: ['websocket', 'polling']});

  // Check connection
  socket.on('connect', () => {
    console.log('Connected to server');
  });
</script>
<script>
  // Example: When a user likes a post
  function likePost(postId, userId) {
    socket.emit("like", { postId, userId });
  }

  // Example: When a user comments
  function commentPost(postId, userId, comment) {
    socket.emit("comment", { postId, userId, comment });
  }
</script>
<script>
  // Listen for new likes
  socket.on("new-like", (data) => {
    console.log("New like:", data);
    alert(`User ${data.userId} liked post ${data.postId}`);
  });

  // Listen for new comments
  socket.on("new-comment", (data) => {
    console.log("New comment:", data);
    alert(`User ${data.userId} commented on post ${data.postId}: "${data.comment}"`);
  });
</script>
<div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="fullImage">
</div>
<!-- Preview for additional images -->
<div id="image-preview-container" style="display: flex; gap: 5px; margin-top: 10px;"></div>

<!-- Image Gallery Modal -->
<div id="galleryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center;">
    <div id="galleryContent" style="display: flex; flex-wrap: wrap; gap: 10px; max-width: 90%; max-height: 90%; overflow-y: auto;"></div>
</div>

<style>
/* Modal Styling */
.thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 5px;
    border: 2px solid #ddd;
    cursor: pointer;
}

.gallery-image {
    width: 100%;
    max-width: 500px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
}

/* Image inside Modal */
.modal-content {
    max-width: 90%;
    max-height: 90%;
    display: block;
    margin: auto;
}

/* Close Button */
.close {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 40px;
    cursor: pointer;
}
/* Container for the entire request feed */
.request-feed-container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 10px;
  box-sizing: border-box;
}

/* Style for the individual request cards */
.request-card {
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.request-card:hover {
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
}
.request-bg{
  background-color: #28a745;
  border: 1px solid #fff;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px ;
}

/* Styling for the user info section */
.request-card .user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.request-card .user-info img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}

.request-card .user-info span {
  font-size: 14px;
  font-weight: bold;
  color: #333;
  margin-left: 45px;
  margin-top: -45px;
}

/* Styling for the request text */
.request-card .text {
  font-size: 16px;
  line-height: 1.5;
  color: #555;
  text-align: center;
  font-weight: 600;
  color: white;
}

/* Styling for the location and budget info */
.request-card .location,
.request-card .budget {
  font-size: 14px;
  color: #777;
  margin-top: 10px;

}

.request-card .location {
  display: flex;
  align-items: center;
  gap: 5px;
}

.request-card .location i {
  color: #007bff;
}

.request-card .budget {
  font-size: 15px;
  color: #28a745;
  font-weight: bold;
}
/* Styling for the timestamp */
.request-card .timestamp {
  font-size: 12px;
  color: #888;
  margin-top: -13px;
  margin-left: 45px;
}

@media (max-width: 768px) {
  .request-card {
    padding: 15px;
  }
}
  .request-card .user-info {
    flex-direction: column;
    align-items: flex-start;
  }

  .request-card .text {
    font-size: 14px;
  }
  .request-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.request-actions button {
  background-color: transparent;
  border: none;
  color: #28a745;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: 20%;
}

.request-actions button:hover {
  color: #28a745;
}
.like-btn {
  color: #666; /* Default color */
  transition: all 0.2s ease;
}

.like-btn.liked {
  color: #28a745; /* Red color for liked state */
}

.like-btn:hover {
  color: #ff0000; /* Red on hover */
  transform: scale(1.1);
}

.like-btn i {
  margin-right: 5px;
}
  .request-card .location,
  .request-card .budget {
    font-size: 13px;
  }
/* Add to your existing styles */
.like-btn i {
  transition: all 0.3s ease;
}

.like-btn:disabled i {
  opacity: 0.7;
}

.like-btn.liked i {
  animation: heartBeat 0.5s;
}

@keyframes heartBeat {
  0% { transform: scale(1); }
  25% { transform: scale(1.3); }
  50% { transform: scale(1); }
  75% { transform: scale(1.3); }
  100% { transform: scale(1); }
}
.request-actions-container {
  position: relative;
  margin-left: auto;
  margin-top: -30px;
}

.ellipsis-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: #666;
  padding: 5px 10px;
  border-radius: 50%;
  transition: background 0.2s;
}

.ellipsis-btn:hover {
  background: #f0f0f0;
}

.dropdown-menu {
  position: absolute;
  right: 0;
  top: 100%;
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  z-index: 100;
  display: none;
  min-width: 150px;
  overflow: hidden;
}

.dropdown-menu.show {
  display: block;
}

.dropdown-item {
  display: block;
  width: 100%;
  padding: 10px 15px;
  text-align: left;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}

.dropdown-item:hover {
  background: #f5f5f5;
}

.dropdown-item i {
  margin-right: 8px;
  width: 18px;
  text-align: center;
}

.delete-btn {
  color: #e74c3c;
}

.report-btn {
  color: #e67e22;
}

.edit-btn {
  color: #3498db;
}
</style>
<script>
  function openImage(imageUrl) {
    const modal = document.getElementById("imageModal");
    const fullImage = document.getElementById("fullImage");

    fullImage.src = imageUrl;
    modal.style.display = "flex";

    // Close the modal when clicking outside the image
    modal.onclick = function (event) {
        if (event.target === modal || event.target.classList.contains("close")) {
            modal.style.display = "none";
        }
    };
}
</script>
<script>
  function showToast(message, color = '#28a745') {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.style.backgroundColor = color;
    toast.style.display = "block";

    setTimeout(() => {
      toast.style.display = "none";
    }, 3000);
  }
</script>
<script>
  // Category Filter Functionality
let currentCategory = 'all';
let allPostsCache = [];
document.addEventListener('DOMContentLoaded', function() {
  const categoryBtns = document.querySelectorAll('.category-btn');

  // Initialize category buttons
  categoryBtns.forEach(btn => {
    btn.addEventListener('click', async function() {
      // Update active button
      categoryBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // Set current category and fetch posts
      currentCategory = this.dataset.category;
      await fetchPostsByCategory();
    });
  });
});


</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
  const categoryFilter = document.querySelector('.category-filter');
  const header = document.querySelector('.head');
  const headerHeight = header.offsetHeight;

  // Calculate the exact position where it should stick (60px from top)
  const stickyPosition = 60;

  // Create spacer element
  const spacer = document.createElement('div');
  spacer.style.height = categoryFilter.offsetHeight + 'px';
  spacer.style.display = 'none';
  categoryFilter.parentNode.insertBefore(spacer, categoryFilter.nextSibling);

  // Initial positioning
  const initialTop = categoryFilter.getBoundingClientRect().top + window.scrollY;

  window.addEventListener('scroll', function() {
    const scrollY = window.scrollY || window.pageYOffset;

    if (scrollY >= initialTop - stickyPosition) {
      // Apply fixed positioning immediately
      categoryFilter.style.position = 'fixed';
      categoryFilter.style.top = stickyPosition + 'px';
      categoryFilter.style.left = '0';
      categoryFilter.style.right = '0';
      categoryFilter.style.zIndex = '100';
      spacer.style.display = 'block';
    } else {
      // Return to normal flow
      categoryFilter.style.position = 'static';
      spacer.style.display = 'none';
    }
  });

  // Force initial calculation to prevent any jump
  window.dispatchEvent(new Event('scroll'));
});
</script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCmu0kXlzWE29eNlRDMoYG0qYyxnC5Vra4",
    authDomain: "salmart-330ab.firebaseapp.com",
    projectId: "salmart-330ab",
    messagingSenderId: "396604566472",
    appId: "1:396604566472:web:60eff66ef26ab223a12efd"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();

  // Request permission and save token
  async function initializeNotifications() {
    if ('Notification' in window) {
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          console.log('Notification permission granted.');
          const token = await messaging.getToken({
            vapidKey: "BCtAsyYJYCSfpg_kXL2aO59szQsPFE3DvmqqLOnW03JTVR88Jb435-jDnUgj0j0mL5VCWLiGGfErTuwQ-XUArho"
          });
          console.log('FCM Token:', token);

          const userId = localStorage.getItem('userId');
          if (userId) {
            await fetch(`${API_BASE_URL}/api/save-fcm-token`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              },
              body: JSON.stringify({ token })
            });
            console.log('Token saved to server');
          }
        } else {
          console.warn('Notification permission denied');
        }
      } catch (err) {
        console.error('Error initializing notifications:', err);
      }
    } else {
      console.warn('Notifications not supported in this browser');
    }
  }

  // Handle foreground messages
  messaging.onMessage((payload) => {
    console.log('Foreground message:', payload);
    if (Notification.permission === 'granted') {
      const { title, body } = payload.notification;
      const { type, postId, senderId } = payload.data || {};

      const notification = new Notification(title, {
        body,
        icon: '/favicon.ico', // Replace with your app icon
        data: { type, postId, senderId }
      });

      notification.onclick = (event) => {
        event.preventDefault();
        const { type, postId, senderId } = event.target.data || {};
        if (type === 'like' || type === 'comment') {
          window.location.href = `post.html?postId=${postId}`; // Adjust to your post page
        } else if (type === 'message') {
          window.location.href = `Messages.html?userId=${senderId}`; // Adjust to your messages page
        }
      };
    }
  });

  // Initialize on load
  window.addEventListener('load', initializeNotifications);
</script>
<script>
// Function to check for new content
async function checkForNewContent() {
  try {
    const userId = localStorage.getItem('userId');
    if (!userId) return;

    // Fetch notification counts from your backend
    const response = await fetch(`${API_BASE_URL}/notification-counts?userId=${userId}`);
    const data = await response.json();

    // Update badges based on response
    updateBadge('alerts-badge', data.alertsCount);
    updateBadge('messages-badge', data.messagesCount);
    updateBadge('deals-badge', data.dealsCount);

  } catch (error) {
    console.error('Error fetching notification counts:', error);
  }
}

// Helper function to update badge display
function updateBadge(badgeId, count) {
  const badge = document.getElementById(badgeId);
  if (!badge) return;

  if (count > 0) {
    badge.style.display = 'inline-block';
    badge.textContent = count > 9 ? '9+' : count;
  } else {
    badge.style.display = 'none';
  }
}

// Check for new content periodically
setInterval(checkForNewContent, 30000); // Check every 30 seconds

// Also check when page loads
document.addEventListener('DOMContentLoaded', checkForNewContent);

// Listen for real-time updates via Socket.IO
socket.on('new-notification', (data) => {
  if (data.type === 'alert') {
    updateBadge('alerts-badge', data.count);
  } else if (data.type === 'message') {
    updateBadge('messages-badge', data.count);
  } else if (data.type === 'deal') {
    updateBadge('deals-badge', data.count);
  }
});
</script>
<script>

  // Socket.IO connection handling
  socket.on("connect", () => {
    console.log("✅ Socket.IO connected with ID:", socket.id);
    const userId = localStorage.getItem("userId");
    if (userId) {
      console.log("👤 Registering user with Socket.IO:", userId);
      socket.emit("joinRoom", userId);
    } else {
      console.warn("⚠️ No userId found in localStorage");
    }
  });

  socket.on("disconnect", () => {
    console.log("❌ Socket.IO disconnected");
  });

  socket.on("connect_error", (error) => {
    console.error("🔥 Socket.IO connection error:", error);
  });

  // Update badge display
  function updateBadge(badgeId, count) {
    const badge = document.getElementById(badgeId);
    if (!badge) {
      console.error(`❌ Badge element not found: ${badgeId}`);
      return;
    }
    console.log(`🔄 Updating badge ${badgeId} with count:`, count);
    if (count > 0) {
      badge.style.display = "inline-block";
      badge.textContent = count > 9 ? "9+" : count;
    } else {
      badge.style.display = "none";
      badge.textContent = "0";
    }
  }

  // Unified badge clearing function
  async function clearBadge(type) {
    const badgeId = `${type}-badge`;
    const userId = localStorage.getItem("userId");
    const token = localStorage.getItem("authToken");

    if (!userId || !token) {
      console.warn("⚠️ User not logged in or no token found");
      return;
    }

    // Immediate UI update
    updateBadge(badgeId, 0);

    try {
      // Notify server to mark as viewed
      const response = await fetch(`${API_BASE_URL}/${type}/mark-as-viewed`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ userId }),
      });

      if (!response.ok) {
        throw new Error(`Failed to mark ${type} as viewed: ${response.status}`);
      }

      const data = await response.json();
      console.log(`✅ ${type} marked as viewed:`, data);

      // Broadcast the update via Socket.IO
      socket.emit("badge-update", { type, count: 0, userId });

      // Fetch updated counts to ensure consistency
      await checkForNewContent();
    } catch (error) {
      console.error(`❌ Error clearing ${type} badge:`, error);
      // Revert UI if API call fails (optional)
      checkForNewContent(); // Fetch latest state to recover
    }
  }

  // Fetch notification counts from server
  async function checkForNewContent() {
    const userId = localStorage.getItem("userId");
    const token = localStorage.getItem("authToken");

    if (!userId || !token) return;

    try {
      const response = await fetch(`${API_BASE_URL}/notification-counts?userId=${userId}`, {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      console.log("📊 Notification counts:", data);

      updateBadge("alerts-badge", data.alertsCount || 0);
      updateBadge("messages-badge", data.messagesCount || 0);
      updateBadge("deals-badge", data.dealsCount || 0);
    } catch (error) {
      console.error("💥 Error fetching notification counts:", error);
    }
  }

  // Listen for real-time badge updates
  socket.on("badge-update", (data) => {
    const userId = localStorage.getItem("userId");
    if (data.userId === userId) {
      console.log("📢 Received badge update:", data);
      updateBadge(`${data.type}-badge`, data.count);
    }
  });

  // Initial setup
  document.addEventListener("DOMContentLoaded", () => {
    console.log("🏁 Page loaded - initializing badges");
    checkForNewContent();

    // Debug badge elements
    setTimeout(() => {
      console.log("🔍 Badge elements:", {
        alerts: document.getElementById("alerts-badge"),
        messages: document.getElementById("messages-badge"),
        deals: document.getElementById("deals-badge"),
      });
    }, 1000);
  });

  // Periodic polling as fallback
  setInterval(checkForNewContent, 30000); // Every 30 seconds


</script>
<script>
  
  // Handle like and comment notifications
  socket.on('notification', (data) => {
    console.log('Received notification:', data);
    showToast(`${data.sender.firstName} ${data.sender.lastName} ${data.type === 'like' ? 'liked' : 'commented on'} your post`, '#28a745');
    // FCM handles the actual notification; toast is for in-app feedback
  });

  // Handle new messages
  socket.on('receiveMessage', (message) => {
    console.log('New message:', message);
    showToast(`New message from ${message.senderId}`, '#28a745');
    // FCM handles the notification
  });

  function likePost(postId, userId) {
    socket.emit('likePost', { postId, userId });
  }

  function commentPost(postId, userId, comment) {
    socket.emit('commentPost', { postId, userId, comment });
  }

  function sendMessage(senderId, receiverId, text) {
    socket.emit('sendMessage', { senderId, receiverId, text });
  }

  function showToast(message, color = '#28a745') {
  const toast = document.getElementById("toast");
  if (!toast) {
    console.error('Toast element not found');
    return;
  }
  toast.textContent = message;
  toast.style.backgroundColor = color;
  toast.style.display = "block";
  setTimeout(() => { toast.style.display = "none"; }, 3000);
}
</script>
<script>
  async function initializeNotifications() {
  if ('Notification' in window) {
    try {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        console.log('Notification permission granted.');
        const token = await messaging.getToken({
          vapidKey: "BCtAsyYJYCSfpg_kXL2aO59szQsPFE3DvmqqLOnW03JTVR88Jb435-jDnUgj0j0mL5VCWLiGGfErTuwQ-XUArho"
        });
        console.log('FCM Token:', token);
        await saveToken(token);

        // Handle token refresh
        messaging.onTokenRefresh(async () => {
          console.log('Token refreshed');
          const newToken = await messaging.getToken({
            vapidKey: "BCtAsyYJYCSfpg_kXL2aO59szQsPFE3DvmqqLOnW03JTVR88Jb435-jDnUgj0j0mL5VCWLiGGfErTuwQ-XUArho"
          });
          await saveToken(newToken);
        });
      } else {
        console.warn('Notification permission denied');
      }
    } catch (err) {
      console.error('Error initializing notifications:', err);
    }
  } else {
    console.warn('Notifications not supported in this browser');
  }
}

async function saveToken(token) {
  const userId = localStorage.getItem('userId');
  const jwt = localStorage.getItem('authtoken');
  if (userId && jwt) {
    try {
      const response = await fetch(`${API_BASE_URL}/api/save-fcm-token`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${jwt}`
        },
        body: JSON.stringify({ token })
      });
      if (response.ok) {
        console.log('Token saved to server');
      } else {
        console.error('Failed to save token:', response.status);
      }
    } catch (err) {
      console.error('Error saving token:', err);
    }
  } else {
    console.warn('No userId or JWT found');
  }
}
</script>
<script>
// Function to get the time difference in a human-readable format
function timeAgo(date) {
  const now = new Date();
  const seconds = Math.floor((now - date) / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  const months = Math.floor(days / 30);
  const years = Math.floor(months / 12);

  if (seconds < 60) return `${seconds} sec ago`;
  if (minutes < 60) return `${minutes} min${minutes !== 1 ? 's' : ''} ago`;
  if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
  if (days < 30) return `${days} day${days !== 1 ? 's' : ''} ago`;
  if (months < 12) return `${months} month${months !== 1 ? 's' : ''} ago`;
  return `${years} year${years !== 1 ? 's' : ''} ago`;
}
</script>

<script src="requestScript.js"></script>
</html> 